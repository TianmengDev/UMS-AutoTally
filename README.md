# UMS-AutoTally

## 项目概述

UMS-AutoTally 是一款专业的自动化工具，专为银联商务 App 设计，用于实现 QR 码收入统计的自动化。本工具通过 ADB (Android Debug Bridge) 自动控制手机设备，模拟用户操作流程，实现对银联商务 App 内多个收款码的自动扫描、收入识别和数据统计功能，并将结果通过钉钉机器人推送通知。

## 软件演示

![UMS-AutoTally 演示](./demo%20screenshot-1.png)

## 功能特点

- **全自动化操作**：自动启动银联商务 App 并完成全流程操作，无需人工干预
- **多码支持**：支持配置多个二维码的自动扫描和识别
- **高精度 OCR 技术**：使用 EasyOCR 进行金额识别，解决数字（特别是5和9）识别困难的问题
- **截图记录**：自动保存截图至手机和本地，按日期分类存储
- **数据统计**：汇总各二维码收入，计算总收入
- **消息推送**：通过钉钉 Webhook 自动推送统计结果
- **错误处理**：完善的异常处理和重试机制，提高程序稳定性

## 技术架构

- **开发语言**：Python
- **外部依赖**：
  - ADB (Android Debug Bridge)：控制安卓设备
  - EasyOCR：高精度文字识别
  - PIL (Pillow)：图像处理
  - Requests：HTTP 请求

## 安装要求

1. **系统要求**：
   - 支持 Python 3.6+
   - 已安装 ADB 工具

2. **Python 依赖**：
   ```
   pip install pillow easyocr requests
   ```

3. **设备要求**：
   - 已连接的安卓设备（支持 USB 或无线连接）
   - 已安装银联商务 App

## 配置说明

使用前需配置以下参数：

1. **ADB 配置**：
   - `ADB_PATH`：ADB 命令路径
   - `DEVICE_ID`：设备 ID，通过 `adb devices` 获取

2. **App 配置**：
   - `APP_PACKAGE`：银联商务 App 包名
   - `APP_ACTIVITY`：主活动名

3. **钉钉通知配置**：
   - `DINGTALK_WEBHOOK`：钉钉 Webhook URL
   - `DINGTALK_SECRET`：钉钉机器人密钥

4. **二维码配置**：
   - 在 `QR_CODES` 列表中配置各二维码名称和相册坐标

## 设备连接

### USB 连接
1. 在手机上启用 USB 调试模式
2. 使用 USB 数据线连接手机和电脑
3. 运行 `adb devices` 确认设备已正确连接
4. 将设备 ID 填入配置中的 `DEVICE_ID` 字段

### 无线连接
1. 确保手机和电脑在同一 WiFi 网络下
2. 先通过 USB 连接设备并运行：
   ```
   adb tcpip 5555
   ```
3. 断开 USB 连接，获取手机 IP 地址
4. 运行连接命令：
   ```
   adb connect <手机IP>:5555
   ```
5. 连接成功后运行 `adb devices` 确认，并将设备 ID (`<手机IP>:5555`) 填入配置

## 使用方法

1. 确保手机已连接电脑（USB 或无线）
2. 配置程序参数
3. 运行程序：
   ```
   python UMS-AutoTally.py
   ```

## 工作流程

1. **初始化**：创建必要的目录结构和环境
2. **启动 App**：自动启动银联商务 App
3. **扫码流程**：
   - 进入对账功能
   - 选择收款码
   - 打开相册选择对应二维码
   - 截图并保存
4. **金额识别**：
   - 截取金额区域
   - 图像预处理（对比度增强）
   - 使用 EasyOCR 进行金额识别
   - 文本清理和数值提取
5. **结果汇总**：计算总收入并格式化结果
6. **通知推送**：将结果通过钉钉机器人发送

## 最新更新

最新版本使用 EasyOCR 代替了 Pytesseract，显著提高了数字识别准确率，特别是解决了以下问题：
- 数字 5 和 9 难以正确识别的问题
- 字符分割不准确导致的错误识别
- OCR 引擎配置复杂的问题

新版 OCR 流程：
1. 截取金额显示区域图像
2. 使用对比度增强预处理图像
3. 使用 EasyOCR 引擎识别文本
4. 提取所有识别结果并合并
5. 清理文本，只保留数字和小数点
6. 使用正则表达式提取有效数值

## 常见问题

1. **识别准确率问题**
   - 调整 `recognize_amount()` 函数中的裁剪区域和图像处理参数
   - 首次运行时 EasyOCR 会下载模型，请保持网络连接

2. **设备连接问题**
   - 确认 ADB 设备连接状态
   - 检查 `DEVICE_ID` 配置是否正确
   - 无线连接不稳定时，尝试重新通过 USB 建立连接

3. **App 操作问题**
   - 调整点击坐标适配不同分辨率的设备
   - 增加等待时间解决界面响应延迟问题

## 注意事项

- 程序依赖屏幕坐标进行操作，不同设备可能需要调整坐标值
- 确保手机屏幕亮度适中，以获得更好的截图质量
- 建议在测试环境验证配置后再用于生产环境
- 无线连接时可能会因网络波动导致连接不稳定，请确保网络环境良好
- 首次运行 EasyOCR 会下载模型文件，可能需要一些时间

## 许可证

本项目采用 MIT 许可证。


